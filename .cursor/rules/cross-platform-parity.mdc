---
description: CRITICAL - All features must work on ALL platforms with centralized logic
alwaysApply: true
---

# Cross-Platform Parity Rules

**This is the most important rule in this project.**

---

## The Platforms

Every feature must work on ALL of these:

| Platform | Location |
|----------|----------|
| Mobile iOS | `/mobile` (Expo) |
| Mobile Android | `/mobile` (Expo) |
| Web Desktop | `/web` (Next.js) |
| Web Mobile | `/web` (Next.js, responsive) |

**Do NOT consider a task complete until all platforms are addressed.**

---

## Single Source of Truth (SSOT)

### One Operation = One Implementation

Every discrete operation (database mutations, business logic, state transitions, calculations) MUST have exactly one authoritative implementation.

```
CORRECT:
  Mobile, Web, Admin all call → POST /api/users/me/gallery/primary
                                (same underlying service function)

WRONG:
  Mobile → custom setPrimary() with local logic
  Web    → different implementation
  Admin  → third implementation
```

When logic changes, you change ONE place. Fragmented implementations drift and create context-specific bugs.

### Where Logic Lives

| Type | Location |
|------|----------|
| Business logic / DB ops | `web/src/lib/services/` |
| Validation | `web/src/lib/validation/` |
| API endpoints | `web/src/app/api/` |
| Constants | `mobile/constants/options.ts` + `web/src/types/index.ts` |

**Constants must be identical across both files.** When modifying one, update the other.

---

## Proactive Violation Reporting

**Report ANY violation you notice—even while working on unrelated tasks.**

1. Note what's wrong and where
2. Suggest the fix (or implement if scope permits)
3. Continue with your original task

Small violations compound into major technical debt.

---

## Completion Checklist

- [ ] Works on iOS, Android, Web Desktop, Web Mobile
- [ ] Uses shared API endpoint (no local business logic)
- [ ] Constants synced between mobile and web
- [ ] No fragmented implementations introduced

---

## Exceptions

Platform-specific capabilities only:
- Push notifications (native vs browser)
- Camera/gallery access patterns
- Haptic feedback
- Native UI components (pickers, sheets)

Even these must share underlying business logic via API.
